<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Swap ETH for TORC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.8.0/ethers.umd.min.js" type="application/javascript"></script>
</head>
<body>
    <button id="connectWallet">Connect Wallet</button><br/>
    <label for="ethAmount">Enter ETH amount:</label>
    <input id="ethAmount" type="text" placeholder="0.0001" onfocus="if(this.value=='') {this.value='';}" onblur="if(this.value=='') {this.value='';}">
    <button id="set50" onclick="setEthAmount(50)" disabled>Set $50</button>
    <button id="set100" onclick="setEthAmount(100)" disabled>Set $100</button>
    <button id="set500" onclick="setEthAmount(500)" disabled>Set $500</button>
    <button id="getQuote" disabled>Get Quote</button>
    <button id="buyTorc" disabled>Buy TORC</button>
    <div id="walletInfo"></div>
    <div id="transactionStatus"></div>
    <div id="quoteDetails"></div>
    <div id="swapDetails"></div>

    <script>
        let signer;
        let routerContract;
        let pairContract;
        let ethPriceUSD;

        const routerAddress = '0xC532a74256D3Db42D0Bf7a0400fEFDbad7694008';
        const pairAddress = '0x157f2d14104A5cBFf12d47311D86ED53784428c2';
        const tokenAddress = '0x4d83764fbab749d1bd1d1fcb7ead7a6c52a169f9';
        const routerABI = [
            "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)",
            "function WETH() external pure returns (address)",
            "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)"
        ];
        const pairABI = [
            "event Swap(address indexed sender, uint amount0In, uint amount1In, uint amount0Out, uint amount1Out, address indexed to)"
        ];

        // EIP-1193 provider detection with multi-injection support (MetaMask preferred)
        function getInjectedProvider() {
            const { ethereum } = window;
            if (!ethereum) return null;
            if (Array.isArray(ethereum.providers) && ethereum.providers.length > 0) {
                const mm = ethereum.providers.find(p => p.isMetaMask);
                return mm || ethereum.providers[0];
            }
            return ethereum;
        }

        async function enableUI(provider) {
            const ethersProvider = new ethers.providers.Web3Provider(provider, 'any');
            await provider.request({ method: 'eth_requestAccounts' });
            signer = ethersProvider.getSigner();
            const address = await signer.getAddress();
            const balance = await ethersProvider.getBalance(address);
            const balanceInEth = ethers.utils.formatEther(balance);
            document.getElementById('walletInfo').innerHTML = `Connected Wallet Address: ${address}<br>Balance: ${balanceInEth} ETH`;

            routerContract = new ethers.Contract(routerAddress, routerABI, signer);
            pairContract = new ethers.Contract(pairAddress, pairABI, signer);
            document.getElementById('buyTorc').disabled = false;
            document.getElementById('getQuote').disabled = false;
            document.getElementById('set50').disabled = false;
            document.getElementById('set100').disabled = false;
            document.getElementById('set500').disabled = false;

            // Fetch current ETH price (USD)
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                ethPriceUSD = data?.ethereum?.usd;
            } catch (e) {
                console.warn('Failed to fetch ETH price:', e);
            }

            // React to account/chain changes
            provider.on?.('accountsChanged', () => window.location.reload());
            provider.on?.('chainChanged', () => window.location.reload());
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            try {
                const provider = getInjectedProvider();
                if (!provider) {
                    alert('MetaMask (or an EIP-1193 wallet) is not available. Please install MetaMask and refresh.');
                    return;
                }
                await enableUI(provider);
            } catch (error) {
                console.error('Error connecting to wallet:', error);
                alert('Failed to connect wallet. See console for details.');
            }
        });

        function setEthAmount(usdAmount) {
            const ethAmount = (usdAmount / ethPriceUSD).toFixed(4);
            document.getElementById('ethAmount').value = ethAmount;
        }

        document.getElementById('getQuote').addEventListener('click', async () => {
            const amountInput = document.getElementById('ethAmount').value;
            if (!amountInput) {
                alert('Please enter an amount of ETH.');
                return;
            }
            const amountETH = ethers.utils.parseEther(amountInput);
            const path = [await routerContract.WETH(), tokenAddress];
            const quote = await routerContract.getAmountsOut(amountETH, path);
            const torcOut = ethers.utils.formatUnits(quote[1], 18);

            const ethValueUSD = (parseFloat(amountInput) * ethPriceUSD).toFixed(2);
            document.getElementById('quoteDetails').innerHTML = `Quote: ${amountInput} ETH will get approximately ${torcOut} TORC. (1 ETH = $${ethPriceUSD}, Total: $${ethValueUSD} USD)`;
        });

        document.getElementById('buyTorc').addEventListener('click', async () => {
            try {
                if (!routerContract || !pairContract) {
                    throw new Error("Contracts not initialized. Please connect your wallet first.");
                }
                const wethAddress = await routerContract.WETH();
                const amountInput = document.getElementById('ethAmount').value;
                const amountETH = ethers.utils.parseEther(amountInput || "0.0001");
                const path = [wethAddress, tokenAddress];
                const to = await signer.getAddress();
                const deadline = Math.floor((new Date()).getTime() / 1000) + 100;
                const tx = await routerContract.swapExactETHForTokens(
                    0,
                    path,
                    to,
                    deadline,
                    { value: amountETH }
                );
                document.getElementById('transactionStatus').innerHTML = `Transaction submitted (Pending): ${tx.hash}`;

                pairContract.once("Swap", (sender, amount0In, amount1In, amount0Out, amount1Out, to, event) => {
                    const ethIn = ethers.utils.formatUnits(amount0In, 18);
                    const torcOut = ethers.utils.formatUnits(amount1Out, 18);
                    document.getElementById('swapDetails').innerHTML = `Swap Details: ${ethIn} ETH swapped for ${torcOut} TORC`;
                });

                await tx.wait();
                document.getElementById('transactionStatus').innerHTML = `Transaction Mined: ${tx.hash}`;
                console.log('Transaction Hash:', tx.hash);
                alert('TORC purchased successfully!');
            } catch (error) {
                console.error('Transaction failed:', error);
                document.getElementById('transactionStatus').innerHTML = `Transaction Failed/Cancelled: ${error.message}`;
                alert('Failed to buy TORC.');
            }
        });
    </script>
</body>
</html>
